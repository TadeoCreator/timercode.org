<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Santa Tracker - TimerCode</title>
<script src="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Cesium.js"></script>
<link href="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
<style>
html, body, #cesiumContainer {width:100%;height:100%;margin:0;padding:0;overflow:hidden;}
body {background: url('background1.jpg') no-repeat center center/cover;}
#logo{position:absolute;top:10px;left:50%;transform:translateX(-50%);width:150px;z-index:20;}
#title{position:absolute;top:70px;left:50%;transform:translateX(-50%);color:white;font-size:32px;font-weight:bold;text-shadow:2px 2px 5px black;z-index:20;}
#infoBox{
    position:absolute;
    top:120px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.8);
    color:white;
    padding:20px 40px;
    font-size:36px;
    border-radius:15px;
    text-align:center;
    z-index:20;
}
#infoBox h1{margin:0;font-size:36px;}
#infoBox h2{margin-top:10px;font-size:18px;font-weight:normal;}
#followBtn, #modeBtn{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    z-index:20;
    padding:8px 16px;
    background:red;
    color:white;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
}
#followBtn{top:320px;}  /* pushed below infoBox */
#modeBtn{top:370px;}    /* pushed below infoBox */
#cityPopup{position:absolute;background: rgba(0,0,0,0.85);color:white;padding:5px 10px;border-radius:5px;font-family:sans-serif;display:none;}
#outCityBtn{margin-left:10px;padding:3px 6px;cursor:pointer;}
#cm1{color:palegreen;font-weight:lighter;}
#cm2{color:red;font-weight:lighter;}
</style>
</head>
<body>
<div class="snow-area" style="position:relative; width:100%; height:100vh; overflow:hidden;">
  <canvas class="snow-canvas" style="position:absolute; inset:0; width:100%; height:100%; pointer-events:none;"></canvas>

  <script>
    (() => {
      const canvas = document.currentScript.previousElementSibling;
      const ctx = canvas.getContext("2d");
      let w, h;
      let flakes = [];

      function resize() {
        w = canvas.clientWidth;
        h = canvas.clientHeight;
        canvas.width = w;
        canvas.height = h;
      }
      resize();
      window.addEventListener("resize", resize);

      function makeFlake() {
        return {
          x: Math.random() * w,
          y: Math.random() * h,
          r: Math.random() * 3 + 1,
          s: Math.random() * 1 + 0.5
        };
      }

      for (let i = 0; i < 120; i++) flakes.push(makeFlake());

      function draw() {
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = "white";
        flakes.forEach(f => {
          ctx.beginPath();
          ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
          ctx.fill();

          f.y += f.s;
          f.x += Math.sin(f.y * 0.01) * 0.5;

          if (f.y > h) {
            f.y = -5;
            f.x = Math.random() * w;
          }
        });
        requestAnimationFrame(draw);
      }
      draw();
    })();
  </script>
</div>
<div id="copos" style="position:relative; width:100%; height:100vh; overflow:hidden;">
  <canvas id="coposCanvas" style="position:absolute; inset:0; width:100%; height:100%; pointer-events:none;"></canvas>

  <script>
    (() => {
      const canvas = document.getElementById("coposCanvas");
      const ctx = canvas.getContext("2d");

      let w, h;
      const SIZE = 3.5;      // tama침o fijo de cada copo
      const SPEED = 1;       // velocidad pareja
      const DENSIDAD = 180;  // cu치ntos copos habr치 (m치s=mas juntitos)
      let flakes = [];

      function resize() {
        w = canvas.clientWidth;
        h = canvas.clientHeight;
        canvas.width = w;
        canvas.height = h;
      }
      resize();
      window.addEventListener("resize", resize);

      function makeFlake() {
        return {
          x: Math.random() * w,
          y: Math.random() * h,
          r: SIZE,
          s: SPEED
        };
      }

      flakes = new Array(DENSIDAD).fill(0).map(makeFlake);

      function draw() {
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = "white";

        flakes.forEach(f => {
          ctx.beginPath();
          ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
          ctx.fill();

          // movimiento uniforme y m치s "pegadito"
          f.y += f.s;
          f.x += Math.sin(f.y * 0.02) * 0.3;

          if (f.y > h) {
            f.y = -10;
            f.x = Math.random() * w;
          }
        });

        requestAnimationFrame(draw);
      }

      draw();
    })();
  </script>
</div>
<div id="musica" style="display:none;">
  <audio id="player" src="snowSs.mp3" loop></audio>

  <script>
    const p = document.getElementById("player");

    // 郊윒잺 Iniciar despu칠s de 2 segundos
    setTimeout(() => {
      if (!p.muted) p.play().catch(()=>{});
    }, 2000);

    // evitar pausa por display:none o por eventos
    const lock = () => {
      if (!p.muted && p.paused) p.play().catch(()=>{});
    };

    setInterval(lock, 500);

    document.addEventListener("visibilitychange", lock);

    // 游댆 Silencio autom치tico el 24 de diciembre
    const hoy = new Date();
    if (hoy.getMonth() === 11 && hoy.getDate() === 24) {
      p.muted = true;
      p.volume = 0;
    }
  </script>
</div>
<img id="logo" src="logo.png" alt="Logo">
<div id="title">Santa Tracker - TimerCode</div>
<div id="infoBox">
    <h1 id="cm1">Come Back Dec. 24</h1>
    <h2 id="cm2">
      To know about us, wait until Dec 24. We make Santa trackers from 2020 - 2025, By TimerCode Corp. 춸 , Project By TadeoCreator Lawed and copyrighted.
      </h2>
</div>
<button id="followBtn">Follow Santa</button>
<button id="modeBtn">2D LIVE</button>
<div id="cesiumContainer"></div>
<div id="cityPopup"><span id="cityName"></span><button id="outCityBtn">Out City</button></div>

<script>
Cesium.Ion.defaultAccessToken = Cesium.Ion.defaultAccessToken;

// Countdown check
function checkDate(){
    const now = new Date();
    const dec24 = new Date(now.getFullYear(),11,24,0,0,0);
    const infoBox = document.getElementById('infoBox');
    
    // LOGICA: Si ya es 24 de Dic o posterior, ocultamos cartel e iniciamos tracker.
    if(now >= dec24){ 
        infoBox.style.display='none'; 
        startTracker(); 
    } else { 
        // Si NO es 24 de Dic, se muestra el cartel.
        infoBox.style.display='block'; 
        requestAnimationFrame(checkDate); 
    }
}
checkDate();

// Funci칩n original para cargar ciudades de respaldo (si la API falla o no es Navidad)
async function loadBackupCities(){
    const response = await fetch('https://raw.githubusercontent.com/lutangar/cities.json/master/cities.json');
    const data = await response.json();
    const extraCities = [
        {name:"Mexiquito", country:"MX", lat:20.9196132, lng:-100.7443112},
        {name:"Monterrey", country:"MX", lat:25.6866, lng:-100.3161}
    ];
    data.push(...extraCities);
    // Convertir formato para que coincida con la estructura de la API visualmente
    return data.map(c => ({
        location: {lng: parseFloat(c.lng), lat: parseFloat(c.lat)}, 
        city: c.name
    }));
}

// Start Tracker Principal
async function startTracker(){
    const viewer = new Cesium.Viewer('cesiumContainer',{
        terrain: Cesium.createWorldTerrain(),
        animation:false, timeline:false, infoBox:false, selectionIndicator:false
    });
    viewer.scene.globe.enableLighting = true;

    // 1. Intentar conectar a la API de Santa Tracker
    let routeData = [];
    let usingRealApi = false;

    try {
        // Usamos un proxy CORS si es necesario para entornos locales, o fetch directo
        const apiUrl = 'https://santa-api.appspot.com/info?client=web&language=en&fingerprint=&routeOffset=0&streamOffset=0';
        const apiResponse = await fetch(apiUrl);
        const apiJson = await apiResponse.json();

        if (apiJson.destinations && apiJson.destinations.length > 0) {
            routeData = apiJson.destinations;
            usingRealApi = true;
            console.log("Conectado a Santa API: Datos recibidos.");
        } else {
            console.log("API vac칤a (fuera de temporada), usando datos simulados.");
            routeData = await loadBackupCities();
        }
    } catch (e) {
        console.log("Error conectando a API, usando respaldo:", e);
        routeData = await loadBackupCities();
    }

    // 2. Configurar la entidad de Santa y la ruta
    const santaPosition = new Cesium.SampledPositionProperty();
    let startTime, stopTime;

    if (usingRealApi) {
        // LOGICA API REAL (Tiempos reales)
        routeData.forEach((stop, index) => {
            // La API devuelve 'arrival' en milisegundos
            const time = Cesium.JulianDate.fromDate(new Date(stop.arrival));
            const position = Cesium.Cartesian3.fromDegrees(stop.location.lng, stop.location.lat, 300000); // Altura fija para visibilidad
            santaPosition.addSample(time, position);
            
            if(index === 0) startTime = time;
            if(index === routeData.length - 1) stopTime = time;
        });
        
        // Ajustar el reloj de Cesium para que coincida con el 칰ltimo punto conocido o el actual
        viewer.clock.startTime = startTime;
        viewer.clock.stopTime = stopTime;
        viewer.clock.currentTime = Cesium.JulianDate.now(); // Intentar ir al tiempo real
        viewer.clock.clockRange = Cesium.ClockRange.CLAMPED;
        
    } else {
        // LOGICA SIMULADA (Loop visual)
        let totalTime = 0;
        const secondsBetweenCities = 10; // Un poco m치s lento para apreciar
        const now = Cesium.JulianDate.now();
        
        for(let i=0; i<routeData.length; i++){
            const nextIndex = (i+1) % routeData.length;
            const start = routeData[i].location;
            const end = routeData[nextIndex].location;
            
            for(let s=0; s<=secondsBetweenCities; s++){
                const t = s/secondsBetweenCities;
                const lat = start.lat + (end.lat - start.lat)*t;
                const lon = start.lng + (end.lng - start.lng)*t;
                const height = 300000 + 60000 * Math.sin(Math.PI*t);
                
                const time = Cesium.JulianDate.addSeconds(now, totalTime+s, new Cesium.JulianDate());
                santaPosition.addSample(time, Cesium.Cartesian3.fromDegrees(lon, lat, height));
            }
            totalTime += secondsBetweenCities;
        }
    }

    const santa = viewer.entities.add({
        name:'Santa Claus',
        position: santaPosition,
        model:{uri:'https://assets.cesium.com/1524860/santa.glb', minimumPixelSize:100, maximumScale:25000},
        path:{resolution:1, material:new Cesium.PolylineGlowMaterialProperty({glowPower:0.8,color:Cesium.Color.RED}), width:12, leadTime:0, trailTime:3600}
    });
    
    // Si usamos la API real, enfocamos a Santa
    viewer.trackedEntity = santa;

    // 3. Efectos 3D (Mantenidos igual)
    function add3DEffects(){
        for(let i=0;i<800;i++){
            viewer.entities.add({
                position:Cesium.Cartesian3.fromDegrees((Math.random()*360)-180,(Math.random()*180)-90,Math.random()*800000+100000),
                point:{pixelSize:3,color:Cesium.Color.WHITE}
            });
        }
        const radar = viewer.entities.add({position:Cesium.Cartesian3.fromDegrees(0,90,300000), ellipse:{semiMinorAxis:200000, semiMajorAxis:200000, material:Cesium.Color.CYAN.withAlpha(0.3)}});
        let radarAngle=0; function rotateRadar(){ radar.ellipse.rotation=radarAngle; radarAngle+=0.02; requestAnimationFrame(rotateRadar);} rotateRadar();
    }
    add3DEffects();

    // 4. Etiquetas de ciudades (Mantenido)
    const dataSource = new Cesium.CustomDataSource('cities');
    routeData.forEach(c => {
        dataSource.entities.add({
            position: Cesium.Cartesian3.fromDegrees(c.location.lng, c.location.lat, 0),
            label: {text: c.city, font:'16px sans-serif', verticalOrigin:Cesium.VerticalOrigin.BOTTOM}
        });
    });
    viewer.dataSources.add(dataSource);

    // 5. Popup de ciudad (Interactividad Mantenida)
    const cityPopup = document.getElementById('cityPopup');
    const cityNameEl = document.getElementById('cityName');
    document.getElementById('outCityBtn').onclick = ()=>{cityPopup.style.display='none';};
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction((click)=>{
        const picked = viewer.scene.pick(click.position);
        if(picked && picked.id && picked.id.label){
            cityNameEl.innerText = picked.id.label.text;
            cityPopup.style.display = 'block';
            cityPopup.style.left = click.position.x+'px';
            cityPopup.style.top = click.position.y+'px';
        }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    viewer.scene.postRender.addEventListener(()=>{
        if(cityPopup.style.display==='block'){
            const cityText = cityNameEl.innerText;
            const cityEntity = viewer.entities.values.find(e=>e.label && e.label.text===cityText);
            if(cityEntity){
                const pos = Cesium.SceneTransforms.wgs84ToWindowCoordinates(viewer.scene, cityEntity.position.getValue(viewer.clock.currentTime));
                if(pos){cityPopup.style.left=pos.x+'px'; cityPopup.style.top=pos.y+'px';}
            }
        }
    });

    // 6. Botones (Follow y Mode)
    let followSanta = true;
    document.getElementById('followBtn').onclick = ()=>{
        followSanta = !followSanta;
        document.getElementById('followBtn').innerText = followSanta?'Follow Santa':'Free Camera';
        if(followSanta) viewer.trackedEntity = santa;
        else viewer.trackedEntity = undefined;
    };
    
    // Actualizaci칩n de c치mara suave
    viewer.clock.onTick.addEventListener(()=>{
        if(followSanta && !viewer.trackedEntity){
             // Fallback manual si trackedEntity se desactiva
             viewer.camera.flyTo({destination:santa.position.getValue(viewer.clock.currentTime), duration:0.5});
        }
    });

    let is2D = false;
    const modeBtn = document.getElementById('modeBtn');
    modeBtn.onclick = ()=>{
        if(!is2D){
            viewer.scene.morphTo2D(1);
            modeBtn.innerText = '3D LIVE';
            is2D = true;
        } else {
            viewer.scene.morphTo3D(1);
            modeBtn.innerText = '2D LIVE';
            is2D = false;
        }
    };
}
</script>
</body>
  </html>
